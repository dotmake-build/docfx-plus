<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>How-To: Create and Add a Custom AntDevice to Host </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="How-To: Create and Add a Custom AntDevice to Host ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/StephenHidem/AntPlus/blob/main/Documentation/docfx/docs/hostingextensions/how-to-create-and-add-antdevice.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">


      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../.././">
            <img id="logo" class="svg" src="../../images/Help.png" alt="Small Earth Technology ANT+ Class Library">
            Small Earth Technology ANT+ Class Library
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="how-to-create-and-add-a-custom-antdevice-to-host">How-To: Create and Add a Custom AntDevice to Host</h1>

<p>This how-to walks through the steps taken to create a custom AntDevice and add it to the host container.			We will use the ANT+ device profile Bike Radar to illustrate the procedure. The example WpfUsbStickApp			illustrates the full example.</p>
<p>Classes derived from AntDevice inherit from the CommunityToolkit.Mvvm NuGet package. This is a very			useful package providing robust support for notifications, commanding, and more.</p>
<h3 id="create-the-custom-ant-device-class">Create the custom ANT device class</h3>
<ol>
<li><p>Add the NuGet package SmallEartTech.AntPlus.Extensions.Hosting to the application project.</p>
</li>
<li><p>Add a new class named BikeRadar and derive from AntDevice.</p>
<p>AntDevice is declared as an ObservableObject. Therefore, your class declaration will include						the partial modifier.</p>
<pre><code class="lang-c#">namespace WpfUsbStickApp.CustomAntDevice
{
public partial class BikeRadar : AntDevice
{
}
}
</code></pre>
</li>
<li><p>Add a PNG file to use as an image/icon to the project and set the build action to &quot;Embedded Resource&quot;.						The Bike Radar image was copied from the Bike Radar specification and saved as a PNG in the						CustomAntDevice solution folder.</p>
</li>
<li><p>Implement required properties in the BikeRadar class. You will override ChannelCount, DeviceImageStream,						and ToString.</p>
<div class="WARNING">
<h5>Warning</h5>
<p>You need to manually declare your ANT specific device class! This const is used as a key when							added to the DI container and the AntCollection will instantiate a device with this key.</p>
</div>
<pre><code class="lang-cs">public const byte DeviceClass = 40;        // this value comes from the Bike Radar device type

public override int ChannelCount =&gt; 4084;   // from master channel period in Bike Radar spec

public override Stream? DeviceImageStream =&gt; GetType().Assembly.GetManifestResourceStream(&quot;WpfUsbStickApp.CustomAntDevice.BikeRadar.png&quot;);

public override string ToString() =&gt; &quot;Bike Radar&quot;;</code></pre>
<p>Generate the constructor from quick refactorings. This should add some more required namespaces.						Change the constructor signature to declare the device specific logger. Bike Radar also supports						CommonDataPages. The list of radar targets is initialized.</p>
<pre><code class="lang-cs">public BikeRadar(ChannelId channelId, IAntChannel antChannel, ILogger&lt;BikeRadar&gt; logger, TimeoutOptions? options)
    : base(channelId, antChannel, logger, options)
{
    CommonDataPages = new CommonDataPages(logger);
    for (int i = 0; i &lt; 8; i++) { RadarTargets.Add(new RadarTarget()); }
}</code></pre></li>
<li><p>Define the device specific data pages.</p>
<pre><code class="lang-cs">/// &lt;summary&gt;Bike radar data pages.&lt;/summary&gt;
public enum DataPage
{
    Unknown = 0,
    /// &lt;summary&gt;Status&lt;/summary&gt;
    DeviceStatus = 1,
    /// &lt;summary&gt;Commend&lt;/summary&gt;
    DeviceCommand = 2,
    /// &lt;summary&gt;Page A: targets 1 - 4&lt;/summary&gt;
    RadarTargetsA = 48,
    /// &lt;summary&gt;Page B: targets 5 - 8&lt;/summary&gt;
    RadarTargetsB = 49,
}</code></pre></li>
<li><p>Add custom properties the device supports. Add CommonDataPages property if the device supports it.</p>
<div class="NOTE">
<h5>Note</h5>
<p>The CommunityToolkit.Mvvm supports properties with ObservableProperty attribute. This attribute							requires the property declaration to be private and the first letter of the property name set as							lowercase. The CommunityToolkit generated partial class uses this private declaration as a							backing store and will create a public property with the first letter capitalized.</p>
</div>
<pre><code class="lang-cs">public enum DeviceState
{
    Broadcasting,
    ShutdownRequested,
    ShutdownAborted,
    ShutdownForced
}

public enum ThreatLevel
{
    None,
    Approaching,
    FastApproach,
    Reserved
}

public enum ThreatSide
{
    Behind,
    Right,
    Left,
    Reserved
}

public partial class RadarTarget : ObservableObject
{
    [ObservableProperty]
    private ThreatLevel threatLevel;
    [ObservableProperty]
    private ThreatSide threatSide;
    [ObservableProperty]
    private double range;
    [ObservableProperty]
    private double closingSpeed;
}

[ObservableProperty]
private DeviceState state;
[ObservableProperty]
private bool clearTargets;
public List&lt;RadarTarget&gt; RadarTargets { get; } = new();
public CommonDataPages CommonDataPages { get; }</code></pre></li>
<li><p>Override Parse. Set the custom properties and/or internal state according to the data page.						Parse common data pages in the default clause.</p>
<pre><code class="lang-cs">public override void Parse(byte[] dataPage)
{
    uint ranges;
    ushort speeds;

    base.Parse(dataPage);
    switch ((DataPage)dataPage[0])
    {
        case DataPage.Unknown:
            break;
        case DataPage.DeviceStatus:
            State = (DeviceState)(dataPage[1] &amp; 0x03);
            ClearTargets = (dataPage[7] &amp; 0x01) == 0;
            break;
        case DataPage.DeviceCommand:
            break;
        case DataPage.RadarTargetsA:
            ranges = BitConverter.ToUInt32(dataPage, 3) &amp; 0x00FFFFFF;
            speeds = BitConverter.ToUInt16(dataPage, 6);
            for (int i = 0; i &lt; 4; i++)
            {
                var threatLevel = RadarTargets[i].ThreatLevel = (ThreatLevel)((dataPage[1] &gt;&gt; (i * 2)) &amp; 0x03);
                RadarTargets[i].ThreatSide = threatLevel == ThreatLevel.None ? ThreatSide.Behind : (ThreatSide)((dataPage[2] &gt;&gt; (i * 2)) &amp; 0x03);
                RadarTargets[i].Range = threatLevel == ThreatLevel.None ? 0 : 3.125 * (ranges &gt;&gt; (i * 6) &amp; 0x3F);
                RadarTargets[i].ClosingSpeed = threatLevel == ThreatLevel.None ? 0 : 3.04 * (speeds &gt;&gt; (i * 4) &amp; 0x0F);
            }
            break;
        case DataPage.RadarTargetsB:
            ranges = BitConverter.ToUInt32(dataPage, 3) &amp; 0x00FFFFFF;
            speeds = BitConverter.ToUInt16(dataPage, 6);
            for (int i = 0; i &lt; 4; i++)
            {
                var threatLevel = RadarTargets[i + 4].ThreatLevel = (ThreatLevel)((dataPage[1] &gt;&gt; (i * 2)) &amp; 0x03);
                RadarTargets[i + 4].ThreatSide = threatLevel == ThreatLevel.None ? ThreatSide.Behind : (ThreatSide)((dataPage[2] &gt;&gt; (i * 2)) &amp; 0x03);
                RadarTargets[i + 4].Range = threatLevel == ThreatLevel.None ? 0 : 3.125 * (ranges &gt;&gt; (i * 6) &amp; 0x3F);
                RadarTargets[i + 4].ClosingSpeed = threatLevel == ThreatLevel.None ? 0 : 3.04 * (speeds &gt;&gt; (i * 4) &amp; 0x0F);
            }
            break;
        default:
            CommonDataPages.ParseCommonDataPage(dataPage);
            break;
    }
}</code></pre></li>
<li><p>Add custom methods to send commands to the ANT device.</p>
<pre><code class="lang-cs">public enum Command
{
    AbortShutdown,
    Shutdown
}

public async Task&lt;MessagingReturnCode&gt; Shutdown(Command command)
{
    return await SendExtAcknowledgedMessage(new byte[8] { (byte)DataPage.DeviceCommand, (byte)command, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF });
}</code></pre></li>
<li><p>Add your custom device to the host services collection. This must be a keyed transient.</p>
<pre><code class="lang-c#">// dependency services
_host = Host.CreateDefaultBuilder(Environment.GetCommandLineArgs()).
UseSerilog().
UseAntPlus().   // this adds all the required dependencies to use the ANT+ class library
ConfigureServices(services =&gt;
{
// add the implementation of IAntRadio to the host
services.AddSingleton&lt;IAntRadio, AntRadio&gt;();

// add custom device to the host
services.AddKeyedTransient&lt;AntDevice, BikeRadar&gt;(BikeRadar.DeviceClass);
}).
Build();
</code></pre>
</li>
</ol>
<p>You have now added a custom device to the services that can be instantiated by AntCollection.					The next steps would be to implement the view and view model for your custom ANT device to use					in your application.</p>
<h2 id="see-also">See Also</h2>
<h4 id="concepts">Concepts</h4>
<ul>
<li><a href="hostingextensionsoverview.html">ANT+ Hosting Extensions Overview</a></li>
<li><a href="../examples/examplesoverview.html">Examples Overview</a></li>
</ul>
<h4 id="other-resources">Other Resources</h4>
<ul>
<li><a href="https://github.com/CommunityToolkit/dotnet">CommunityToolkit.Mvvm</a></li>
</ul>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/StephenHidem/AntPlus/blob/main/Documentation/docfx/docs/hostingextensions/how-to-create-and-add-antdevice.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          Documentation built 12/05/2025 21:00:02.<br>&#169; 2022 Stephen Hidem.
        </div>
        <div class="flex-fill text-end">
          <span>Made with <a href="https://dotmake.build/docfx-plus/">docfx-plus</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
